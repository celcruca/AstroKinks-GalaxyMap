/* =============================================================================
 * Project : アストロキングス - 蠱毒な銀河へようこそ！
 * File    : AGENTS.md
 * Version : Ver. 0.02 / Rev. 035
 * Date    : 2025-03-08 (土)
 * Library : -
 * Function: 統合ガバナンス・技術正典・構造正典（Rev.035）
 * Notes   :
 *   - ★本改修: シングルクリック選択は描画のみ更新し、ビューの自動センタリングを禁止。
 *   - ★本改修: ステータス文言を日本語へ統一し、文字化けを防止。
 *   - ★本改修: THEME.selection.color を黄色 (0xffd400) に定義し、選択ヘクスのハイライト色を正典化。
 *   - ★本改修: ダブルクリックで TGT-連番ターゲットを登録／解除する青色マーキング手順を追加。
 *   - ★本改修: TGT 登録時に任意名称を設定可能とし、未指定時は TGT-NNN ラベルを描画。
 *   - ★本改修: 検索機能に TGT (座標・名称) を統合し、選択解除で全 TGT を同時解除するリセット仕様を追加。
 *   - ★本改修: オブジェクト間の直線距離計測と測定ラインの正典化を実装。
 *   - ★本改修: 弾着計算メニューで発地点/着弾点を指定し、距離算出ボタンで直線距離を算出。結果はメニュー内に表示し、マップ上は線のみ描画する。
 *   - ★本改修: 弾着計算メニューの UI レイアウトを正典化（初期状態は折りたたみ／項目ごとに 1 行構成／距離確認ボタン・行軍距離 000 へクス 表示・行軍時間の MM:SS,cc 表示）。
 *   - ★本改修: 距離確認ボタンの右に「集結カウント」ボタンを追加し、距離確認と同寸・同スタイルで横並び配置する。
 *   - ★本改修: 弾着時間入力を MM:SS 形式（40:00 既定）へ統一し、4 桁数値や全角入力も自動正規化して時間補正ボタンで即時カウントダウンを再開する仕様を正典化。
 *   - ★本改修: STRIKE.marchAdjustmentSeconds を -1 秒で正典化し、行軍時間算出に補正を適用する。
 *   - ★本改修: 弾着時間カウントダウン中に集結カウントを押下すると、選択した集結時間に合わせた発射タイミングを算出し、弾着残り時間から行軍時間を差し引いた MM:SS.cc 表示ポップアップで集結開始までのカウントダウンと目標情報を提示する仕様を追加。
 *   - ★本改修: 弾着時間の入力フォーカス中はカウントダウンが値を上書きせず、時間補正ボタン押下時に入力値からカウントダウンを再開する仕様を徹底。
 *   - ★本改修: 選択解除操作で距離計測ラインと関連カウントダウン（集結ポップアップ含む）を即時リセットする仕様を追加。
 *   - ★本改修: トップパネルの配置を調整し、ルーラー帯と干渉しないよう上余白を 56 px に統一。
 *   - ★本改修: 弾着時間行を行軍時間とネスト効果の間に配置し、入力フォーカス中はカウントダウン表示を一時停止する UI ルールを追加。
 *   - ★本改修: 着弾目標トグル（惑星／衛星／拠点／PvP）を追加し、集結時間トグルの直前に配置。既定選択は惑星。
 *   - ★本改修: STRIKE.secondsPerHex にターゲット別の行軍秒数係数を定義し、ネスト外選択時は +10% 加算で行軍時間を算出。
 *   - ★本改修: 着弾地点が貿易惑星の場合は自動で着弾目標を惑星に、衛星またはテネブリースの場合は自動で衛星に切り替え、行軍時間計算へ反映。
 *   - ★本改修: ネスト効果トグルの既定選択を「ネスト内」とし、main.js/state.nestMode の初期値と DOM の初期クラスを同期。
 * =============================================================================
 */

# アストロキングス - 蠱毒な銀河へようこそ！ — 統合 Canon / Governance（唯一の正典）

---

## 0. 目的 / スコープ
本ドキュメントは **アストロキングス - 蠱毒な銀河へようこそ！** における **設計・実装・提示・レビュー** の唯一の規範である。  
指示の優先順位は **S1 (プラットフォーム) > ガバナンス (本章) > map-config.js > 通常指示** とする。

---

## 1. ガバナンス（AGENTS準拠・最上位ルール）
- **設定優先順位**：S1 > 本書 > map-config.js > 通常指示。  
  - map-config.js は SSoT として正典値を上書き可能。  
  - 座標系・変換式・マスク禁止範囲・200/400/600/800 ガイド基準・クロスヘア単線・ルーラー = 10進表示などの**不変正典**は変更不可。  
  - map-object.js など他ファイルは map-config.js の値に追従する。  
  - 正典逸脱時は Notes に ★本改修: を記載し、§5 C-2 / C-6 / C-7 / C-8 を再検証。

### 1.1 指示優先順位（正式定義）
- **S1** : プラットフォーム仕様（ブラウザ / OS / 描画エンジン）  
- **S2** : 本 Canon（不変正典：座標系・変換式・マスク禁止範囲・HUD・ルーラー・クロスヘア・固定帯）  
- **S3** : map-config.js（可変正典：ズーム範囲・ルーラー刻み閾値・HUD値の微調整）  
- **S4** : 通常指示（チケット / 口頭 / チャット） 

### 1.2 管理原則
- 不変正典は **S2のみ変更可**。S3/S4 では変更禁止。  
- 変更提案は Validation Stamp により承認。  
- 差分は Git 管理下で追跡し、Rev 番号を明示。

### 1.3 言語・文字化け対策
- 基準言語は日本語。  
- 文字化けを検知した場合、差分修正を行わずロールバックしてから再開する。  
- UTF-8 / LF 検証 (file -bi / nkf -g)。    
- 発生原因と再発防止策を Notes 欄の「★本改修:」に記載。

### 1.4 提示ルール
1. 全提示は Markdown（.md）形式。 
2. **ヘッダ必須**：ヘッダテンプレートに従う（Library は使用ライブラリ（モード）、未使用文書の場合は "-" 固定）。  
3. **全文提示**：差分貼付・未実装残しは禁止。  
4. **Rev運用**：提出毎に Rev を +1（3桁ゼロ詰め）、Date は JST 曜日付き。  
5. **受入チェック**：§5 C-1〜C-10 の結果を添付。  
6. **応答スタンプ**：[AK-COMPLIANCE] ブロックで報告。

```
		text
/* =============================================================================
 * Project : <プロジェクト名>
 * File    : <ファイル名>
 * Version : Ver. <V> / Rev. <NNN>
 * Date    : <YYYY-MM-DD (曜)>
 * Library : <利用ライブラリ名> (<モード名など併記>)   // 文書の場合は "-" 固定
 * Function: <役割1行要約>
 * Notes   : <依存/注意/備考。逸脱は "★本改修:" で列挙>
 *   - ★本改修: 弾着計算メニューで発地点/着弾点を指定し、距離算出ボタンで直線距離を算出。結果はメニュー内に表示し、マップ上は線のみ描画する。
 *   - ★本改修: 弾着時間入力を MM:SS 形式（40:00 既定）に統一し、4 桁数値・全角入力も自動正規化して時間補正ボタンで即時カウントダウンを再開する仕様を正典化。
 * =============================================================================
 */
```

---

## 2. 技術正典
### 2.1 グリッド
- 座標系：odd-r offset（pointy-top）。  
- 描画対象は **10進（デカルト座標） 000:000 〜 999:999** のみ。  
- 疎化式：z >= 1 で step=1、縮小時は quantizeUp により動的決定。  
- snap05(v)=floor(v)+0.5 による丸めを徹底し、往復誤差 ±0.5px を維持する。

### 2.2 HUD / グリッド
- グリッド線：線幅 1 px / α = 0.35 / 色 #2f5678（ブルースチール）。  
- 200/400/600/800 ガイド：線幅 4 px / α = 0.25 / 色 THEME.guideColor。  
- ルーラー帯：上 40 px / 左 48 px 固定。ラベルは帯中央に配置し 10 進・3 桁ゼロ詰めで、1/5/10/25/50/100 から動的に刻みを自動選択（縦横連動）。  
- クロスヘア：単線 2 px、ラベルは [qqq:rrr] 表示。world 外では非表示。  
- 暗幕：world 外を α = 0.35 で遮蔽し、固定帯との境界を明示する。

### 2.3 オーバーレイ / ラベル
- アストロネスト：OBJECTS.nest の色階調を使用し、外周セルはネスト色で描画。SUBF は #7acfa0 を用いる。  
- ネスト塗り：中心ヘクスは不透明 (α=1)、外縁ヘクスは outerAlpha = 0.45 で塗布し、外周強調は下記 8 手順を厳守する。  
  1. gatherHexCells(centerQ, centerR, radius) で半径 radiusHex の六角格子を取得し、isInsideWorld(q,r) で 000:000〜999:999 以外を除外する。  
  2. 中心セル (distance=0) は palette.NEST を α=1 で塗布し、隣接リング (distance=1) は同色を α=nestOuterAlpha で塗布する。距離>=2 のセルは `scaleColor(accentColor, nestOuterIntensity)` を α=nestOuterAlpha で塗布し、外縁セルで α や色を変調しない。  
  3. perimeterEdges 構築：各セルの 6 辺について getHexPoints() から取得した座標を昇順キー `getCanonicalEdgeKey(p1,p2)` により Map に登録し、出現回数 count===1 の辺のみを perimeterEdges とする。normal にはセル中心→辺中点ベクトルの単位化結果を保存する。  
  4. buildEdgeLoops(perimeterEdges) は、edge.start/end の座標キーを formatPointKey() で連結グラフにし、traceLoop() で閉路 (segments) を求める。guardLimit = edges.length * 2、閉路が成立した場合のみ採用し、未閉路は fallback 処理に委ねる。  
  5. traceLoop() 内では makeSegment(start,end,normal) でエッジ方向と法線を保持し、negateVector() で反転法線を補正する。segmentsToVertices() で頂点列を生成し、computeVertexNormals() で前後エッジ法線の正規化和を求める。  
  6. highlight 設定：`highlightWidth = OBJECT_STYLE.nest.highlightWidth ?? Math.max((OBJECT_STYLE.nest.borderWidth ?? 2) * 1.75, 3)`、`highlightMargin = Math.max(OBJECT_STYLE.nest.highlightOffset ?? 0.5, 0.5)`、`highlightDistance = highlightMargin + highlightWidth * 0.5`。色は `highlightColorScale = clamp(OBJECT_STYLE.nest.highlightColorScale ?? 1.2, 0, 2)` を反映し、 PIXI.Graphics.lineStyle({ alignment:0.5, join:MITER, cap:BUTT }) で描画。  
  7. offsets: `offsetVerticesByNormals(vertices, vertexNormals, highlightDistance)` で外向き頂点群を算出し、drawRing() で highlight を一筆描き。原位置の頂点群は border 用 Graphics (alignment:0) で描画し、ハイライトより内側に重ねる。  
  8. buildEdgeLoops() で閉路が得られなかった辺は drawOuterHighlightSegments() へ渡し、normal ベースで highlightDistance 分外向きに線分を描く。同時に borderWidth で元位置の線分も描いて継ぎ目を埋める。  
- ラベル描画：ラベルはズーム倍率に依存しない固定フォントで描画し、world スケール変更時は逆スケールで補正して常に画面上のサイズを一定に保つ。  
- 選択ハイライト：シングルクリックしたヘクスは `THEME.selection.color`（既定 0xffd400）の外周線で描画し、ビュー座標は保持する（自動センタリング不可）。  
- 弾着計算：メニューは初期状態で折りたたみ (`aria-expanded=false`) とし、項目ごとに 1 行構成で「発射地点」「着弾地点」「距離確認」「行軍距離」「行軍時間」「弾着時間」「ネスト効果」「着弾目標」「集結時間」を縦並びに配置する。行軍距離の結果は ``NNN へクス`` 表示（px 値は併記しない）とし、OBJECTS.measurement の線のみマップに描画する。行軍時間は ``MM:SS,cc`` 表示で、STRIKE.secondsPerHex のターゲット係数とネスト効果 (+10%) に STRIKE.marchAdjustmentSeconds （既定 -1 秒）を加算して算出する。弾着時間欄は ``MM:SS`` 形式（既定 ``40:00``）の入力窓と時間補正ボタンで構成し、行軍時間の直下に配置する。時間補正時はフォーカス中の値をそのまま採用し、即座にカウントダウンを再スタートする。入力フォーカス中はカウントダウン表示で上書きしない。距離確認行では右側に「集結カウント」ボタンを同じ高さで横並び配置し、距離算出結果が未確定の間は無効化する。距離確認ボタンと「集結カウント」ボタンはメインメニューと同寸のボタンスタイルを共有し、「集結カウント」押下時は最新の行軍距離／行軍時間と選択した集結時間を用いて発射時刻を逆算し、弾着時間カウントダウンが進行中であれば `目標：<名称 or 座標>` と ``{集結分}分集結までのカウントダウン： MM:SS.cc`` の 2 行で構成されるポップアップを表示して集結開始までの残時間を提示する。ネスト効果は同一行に二択トグルボタンを並列配置し、既定選択は「ネスト内」とする。着弾目標トグルは四択（惑星／衛星／拠点／PvP）で集結時間トグルの直上に配置し、既定選択は惑星。  
- トップパネル：ルーラー帯と重ならないよう上余白を 56 px に設定し、HUD と視覚的干渉を起こさない位置で固定する。  
- ネスト名ラベル：フォントサイズ 18、中心ヘクスの真上（アンカー 0.5 / 0.5）に配置し、直下に 16 pt の ``[qqq:rrr]`` 座標ラベルを表示する（改行を含めた全体の重心が対象ヘクスの中心に一致するよう補正する）。ズームが 10% 以下では座標ラベルを非表示にし、5% 以下ではネスト名の描画スケールを縮めて画面上の文字サイズを段階的に下げ、下限 10 pt を維持する。  
- 衛星名ラベル：フォントサイズ 16、アンカー 0.5 / 0 に設定し、対象ヘクス直下（ヘクス半径 + 10 px）へ配置する。互いのラベルと干渉する場合は衛星ラベルを一斉非表示とする。

### 2.4 ビューポート / クランプ
- 標準中心：GEOMETRY.STANDARD_CENTER = { q: 500, r: 478 }。標準サイズボタン／初期表示ともにテネブリース中心へフォーカスする。  
- シングルクリック選択ではビュー座標を保持し、フォーカス移動は行わない（TGT／オブジェクトへのフォーカスはそれぞれのハンドラが実施）。  
- クランプ：000:000〜999:999 を安全帯内で完全表示する左上基準クランプを維持し、余白が生じる場合でも左上は固定する。  
- 安全帯：上 40 / 左 48 / 右 4 / 下 6 px。ズーム／パン時はこの帯を除いた内側領域で world を収める。

### 2.5 SSoT 抜粋（map-config.js）
- HEX_R = 24、WORLD_COLS/ROWS = 1000、WORLD_MARGIN_HEX = 0。  
- APP.background = 0x0b0f16、CAMERA.wheelStep = 0.15、minZoom = 0.001、maxZoom = 3。  
- HUD.RULER：majorTick = 10 / minorTick = 6 / fontSize = 16。  
- OBJECTS.nest.outerAlpha = 0.45、selection.glowAlpha = 0.6。  
- THEME.selection.color = 0xffd400（選択ハイライトの参照色）。  
- OBJECTS.target：fillColor = 0x49a8ff、fillAlpha = 0.6、borderColor = 0xffffff、borderAlpha = 0.9、borderWidth = 2、labelFontSize = 16、labelColor = 0xffffff。  
- OBJECTS.measurement：lineColor = 0xff9f1a、lineAlpha = 0.9、lineWidth = 5、markerRadius = 6、markerColor = 0xffffff、markerAlpha = 0.95、labelFontSize = 16、labelColor = 0xffffff。  
- STRIKE.secondsPerHex：planet = 1.128697 / satellite = 1.53 / base = 1.23 / pvp = 1.1175。値が異なる場合は map-config.js を正典に合わせて修正する。

### 2.6 ズーム / クランプ
- 最小ズームは表示領域の短辺を基準とした 1/2 サイズまで自動調整。  
- マップが表示領域より小さくなる場合は左上基準でクランプし、外周が常に視界内に収まるようにする。

---

## 3. UI固定帯
| 帯 | 幅(px) | 内容 |
|----|--------|------|
| 上 | 40 | X軸ルーラー |
| 左 | 48 | Y軸ルーラー |
| 右 | 4 | セーフゾーン |
| 下 | 6 | セーフゾーン |

---

## 4. 運用フロー
1. 指示優先順位 S1→S4 を遵守。  
2. Notes に変更点（★付き）を記録。  
3. 提示時は §5 のチェック項目を添付。  
4. ステータス表示は日本語固定とし、想定外の文字化けを検知した場合は原因を調査してから再提示する。  
5. 検索はオブジェクトの表示専用とし、選択状態や弾着計算の発地点・着弾点には影響を与えない。

### 4.1 クラッシュ復旧ハンドブック（最低限）
1. **SSoT の確認**  
   - map-config.js を開き、§2.5 の値（HEX_R・HUD・THEME.nest・OBJECTS.nestLabelFontSize 等）が正しいか照合する。  
   - map-object.js の OBJECT_LIST を確認し、座標キーがすべて 000:000〜999:999 内に収まっていること。  
2. **ビューポート整合**  
   - map-core.js の clampWorldIntoView が安全帯（上40 / 左48 / 右4 / 下6）を参照し、左上クランプを維持する実装になっているか確認。  
   - 起動後に標準ビュー（applyStandardView）で 500:478 が中央に表示されることを検証する。  
3. **HUD / ラベル**  
   - map-hud.js のルーラーラベルが帯中央に配置され、pad3 表記で表示されるか（horizontalLabelY / verticalLabelX）。  
   - map-overlay.js のラベル配置がネスト=中心・衛星=ヘクス下側であること、外周境界線がネスト色で描画されること。  
4. **実地チェック**  
   - 起動後、 00:000・999:999 を含む四隅をスクリーンショット取得し、安全帯に隠れていないことを確認。  
   - AK-COMPLIANCE スタンプにクラッシュ復旧確認済みと記す（必要に応じて証跡を添付）。

### 4.2 TGT ターゲット運用
1. **登録**：ダブルクリックで対象ヘクスをトグル登録する。採番は `TGT-001` から始まり、解除した番号は再利用する。  
2. **名称**：登録直後の入力ダイアログで任意名称を設定できる。空文字またはキャンセル時は採番ラベル（TGT-NNN）のみ描画する。  
3. **描画**：登録済みヘクスは `OBJECTS.target` の塗り／枠線値を用いて強調表示し、ラベルは labelLayer 上に固定表示する。  
4. **検索**：座標 (`123:456`)、正確な名称、部分一致名称のいずれでも TGT が検索対象になる。ヒット時は `focusOnTarget` により該当ヘクスを画面中心へ移動させ、ステータスに表示名を出力する。  
5. **解除**：再度ダブルクリック、または選択解除ボタンで登録済み TGT を全て解除し、採番シーケンスを初期化する。

### 4.3 距離計測ハンドリング
1. **発地点入力**：弾着計算メニューの発地点欄にオブジェクト名または座標 `qqq:rrr` を入力する（検索機能とは独立して動作する）。  
2. **着弾点入力**：着弾点欄にも同様に入力し、両方ともワールド内座標であることを確認する。  
3. **距離算出**：`距離確認` ボタンを押下すると直線距離を算出し、結果をメニュー内の「行軍距離」に ``NNN へクス`` 形式で表示し、同時に「行軍時間」に ``MM:SS,cc`` 形式で表示する。STRIKE.secondsPerHex の係数とネスト効果 (+10%) に STRIKE.marchAdjustmentSeconds（既定 -1 秒）を加算して算出し、入力不足や同一点の場合は両表示と線をクリアし、「集結カウント」ボタンも非活性化する。  
4. **集結カウント**：「距離確認」で算出済みの行軍距離／行軍時間があり、かつ時間補正による弾着カウントダウンが進行中の場合のみボタンを活性化する。押下時は最新結果と選択中の集結時間を用いて発射時刻を逆算し、集結開始までの残時間（弾着残り時間 − 行軍時間 − 集結時間）をカウントダウンする。ポップアップには ``目標：`` 行（オブジェクト名／未登録時は座標）と ``{集結分}分集結までのカウントダウン： MM:SS.cc`` 行を表示し、残り時間が 0 になると集結開始タイミングを通知する。距離結果がクリアされた場合は即座にボタンとポップアップを無効化し、押下イベントを無視する。  
5. **着弾目標トグル**：着弾地点が貿易惑星である場合は自動で着弾目標を惑星に、衛星またはテネブリースである場合は自動で衛星に切り替える。手動操作時は四択トグル（惑星／衛星／拠点／PvP）が排他で選択され、行軍時間計算に即時反映する。  
6. **描画**：マップ上には OBJECTS.measurement のスタイルで線のみ描画し、マーカーやラベルは生成しない。  
7. **弾着時間補正**：行軍距離の直下にある ``弾着時間：`` ラベル付き ``MM:SS`` 入力窓へ所要弾着時間を入力する。半角・全角いずれの数字/コロンでも受け付け、4 桁以内の数値のみでも ``MMSS`` として自動整形する。「時間補正」ボタン押下時にフォーカス中の値を採用し、即座にカウントダウンを再スタートする。未入力や形式不正時は ``40:00`` へ戻す。入力フォーカス中はカウントダウン表示で上書きせず、補正完了後に再表示する。  
8. **選択解除**：「選択解除」ボタンを押下すると距離計測ライン・行軍結果・集結カウントダウン・関連ポップアップを即時リセットし、測定状態を初期化する。  

---

## 5. 受入チェック
| No | 観点 | 合否 | 検証方法 |
|----|------|------|-----------|
| C-1 | ルーラー値(10進)↔world 誤差 ±0.5 px | □ | 実測 |
| C-2 | 200/400/600/800 ガイド整合 | □ | スクショ |
| C-3 | 縦線二重描画なし | □ | 動画 |
| C-4 | HUD snap05 正常 | □ | スクショ |
| C-5 | world 外描画なし | □ | ビュー端確認 |
| C-6 | ガイド α = 0.25 | □ | スクショ |
| C-7 | ルーラー値 = 10進座標 | □ | スクショ |
| C-8 | クロスヘア線幅 2 px / HUD 非干渉 | □ | 動画 |
| C-9 | ガイド交点誤差 ±0.5 px | □ | 実測 |
| C-10 | 縦ライン二重描画なし（静止画/連続ズームで再現なし） | □ | スクショ＋連続ズーム動画 |

---

## 6. 管理・責任
| 役割 | 担当 |
|------|------|
| Canon Owner | Product Lead |
| Change Approver | Tech Lead |
| Doc Maintainer | Documentation Lead |

---

## 7.1 Current Canon (Rev.034)
- map-config.js: HUD/guide/crosshair パレットを SSoT として保持しつつ、CAMERA.minZoom = 0.001・ネスト外周 α = 0.45・THEME.selection.color = 0xffd400・OBJECTS.target／OBJECTS.measurement（lineWidth = 5）のスタイルを正典化し、STRIKE.secondsPerHex に惑星／衛星／拠点／PvP 用の行軍秒数係数、STRIKE.marchAdjustmentSeconds = -1、STRIKE.impact.defaultSeconds = 40 × 60 を保持する。  
- map-core.js: SAFE 帯 (top40/left48/right4/bottom6) を考慮した左上クランプと表示短辺 1/2 ルールを維持し、シングルクリック選択ではビュー位置を固定する。  
- main.js: 「標準サイズ」で標準中心 { q:500, r:478 } にフォーカスし、ステータス表示を日本語へ統一。検索はオブジェクト表示専用とし選択や距離計測を行わず、弾着計算メニューを初期状態で折りたたみ、発地点/着弾点入力・距離確認（結果は ``NNN へクス`` 表示）と右隣に配置する「集結カウント」ボタンで算出済みの行軍距離／行軍時間を集結時間カウントダウンへ連携し、距離結果がリセットされた際はボタンも非活性化する。さらに ``MM:SS,cc`` 表示の「行軍時間：」、``40:00`` 既定の「弾着時間：」ラベル付き ``MM:SS`` 窓と「時間補正」ボタンによるカウントダウン制御を担保。行軍時間は着弾目標トグルに応じて STRIKE.secondsPerHex の係数を選択し、ネスト外選択時は +10% で算出した後 STRIKE.marchAdjustmentSeconds（-1 秒）を加算する。時間補正で弾着カウントダウンが進行している状態で「集結カウント」を押下した際は、弾着残り時間から行軍時間を差し引いた ``MM:SS.cc`` 表示のポップアップを生成して集結残り時間をリアルタイムに提示する。着弾目標トグルの既定は「惑星」で、貿易惑星を着弾地点に指定した場合は自動で惑星、衛星またはテネブリースを指定した場合は自動で衛星へ切り替えて計算する。入力フォーカス中はカウントダウン値で上書きしない。ネスト効果トグルの既定は「ネスト内」。  
- map-hud.js: snap05・10進 3 桁ラベル・SAFE 帯遮蔽・ルーラー 000〜999 クランプ・クロスヘア描画を維持。  
- map-overlay.js: ネスト外縁 α = 0.45 の perimeterEdges 描画を継続し、選択ハイライト色を THEME.selection.color に合わせる。TGT 専用レイヤーで青色塗り＋ラベル描画を維持し、弾着計算の線は OBJECTS.measurement の正典値でのみ描画し、マーカーやラベルは生成しない。  
- styles.css: HUD と干渉しないパネル配色・シャドウを維持。

### Outstanding Items
- なし

[Canon Validation Stamp]  
Document : AGENTS.md  
Project   : アストロキングス - 蠱毒な銀河へようこそ！  
Version   : Ver.0.02 / Rev.034  
Verified  : シングルクリック時の静的ビュー維持／THEME.selection.color による選択ハイライト描画／TGT 登録・任意名称・採番再利用／弾着計算メニューの初期折りたたみ・距離確認ボタンと右隣の集結カウントボタン配置／行軍距離（NNN へクス）表示と集結カウント連携／行軍線描画を OBJECTS.measurement.lineWidth = 5 で太線化／行軍時間 (MM:SS,cc) と STRIKE.secondsPerHex によるターゲット別 + ネスト外 +10% 計算に STRIKE.marchAdjustmentSeconds (-1 秒) を加算する行軍時間補正／距離結果直下へ配置した「弾着時間：」ラベル付き MM:SS 窓（既定 40:00）の時間補正・4 桁入力/全角正規化・編集中の表示保護仕様／時間補正カウントダウン進行中に「集結カウント」押下で目標表示（名称／座標）と ``{集結分}分集結までのカウントダウン： MM:SS.cc`` を呈示し、弾着残り−行軍時間−集結時間による集結開始タイミングを逆算するポップアップの生成／選択解除で距離計測ラインと集結カウントダウンを即時リセット／着弾目標トグル（惑星／衛星／拠点／PvP）の既定・排他選択と貿易惑星/衛星/テネブリース時の自動切替  
Approved  : Tech Lead / Product Lead / Documentation Lead  
[/Canon Validation Stamp]

---

## 3. 不変／可変マトリクス（正典の所在）
| 項目 | 不変/可変 | 正典の所在 | 説明 |
|---|---|---|---|
| 座標系（odd-r, pointy-top 等） | 不変 | 本Canon(S2) | 変更不可 |
| ルーラー表記（10進/ゼロ詰め/3桁） | 不変 | 本Canon(S2) | 10進・3桁・接頭辞なし |
| HUDガイド（200/400/600/800, α=0.25） | 不変 | 本Canon(S2) | 値固定 |
| クロスヘア（単線, 線幅2px） | 不変 | 本Canon(S2) | 太さ・形状固定 |
| 暗幕（world外 α=0.35） | 不変 | 本Canon(S2) | 変更不可 |
| 左上クランプ方式 | 不変 | 本Canon(S2) | 方式固定（境界条件は本書に準拠） |
| ルーラー刻み自動選択(1/5/10/25/50/100) | 可変 | map-config.js(S3) | 閾値・連動条件をS3で調整 |
| 最小ズーム/最大ズーム | 可変 | map-config.js(S3) | 端末解像度・用途で調整 |
| スナップ/量子化の閾値 | 可変 | map-config.js(S3) | スナップ半径/しきい値 |

---

## 4. 受入テスト詳細（手順と合否基準）
### C-1 ルーラー値(10進)↔world 誤差 ±0.5px
- **環境**: 1920×1080, DPR=1.0, 100%表示
- **手順**: 上ルーラー・左ルーラーの目盛 00, 050, 100, 150... 上にクロスヘアをスナップさせスクショ取得
- **判定**: 目盛線とworld軸が±0.5px以内で一致

### C-3/C-10 縦ライン二重描画なし（統合）
- **手順**: 25%→50%→100%→200%→400% で連続ズーム録画（30fps）
- **判定**: r軸/縦ガイドに重ね線・ちらつきが発生しない

### C-7 ルーラー値 = 10進座標
- **手順**: 代表点(0,0)/(50,0)/(100,100)/(150,250)でHUD数値と座標ラベルを比較
- **判定**: 3桁ゼロ詰めの10進で一致（例: 150→150）

### C-9 固定帯の境界整合
- **手順**: 上40/左48/右4/下6 の固定帯でグリッドの原点がズレないことを確認
- **判定**: 原点は固定帯の内側に一致（±0.5px以内）

---

## 5. 用語集（Glossary）
- **world**: UI固定帯を除いた論理描画面の可視領域矩形
- **z**: 画面ズーム倍率（1.0=原寸）
- **quantizeUp(n, step)**: ceil(n/step)*step を返す量子化関数
- **snap05(v)**: floor(v)+0.5 に丸める補助関数
- **マスク禁止範囲**: world外を暗幕で遮蔽する領域（α=0.35）

---

## 8. 実装リファレンス（抜粋）
> 次Revで追加。API/描画擬似コード/エッジケース集を収載予定。

## 9. 運用フローと権限
> 次Revで追加。S1〜S4の変更申請、承認順、ロール定義。

## 10. 変更管理（テンプレ/ロールバック）
> 次Revで追加。★本改修テンプレ、ロールバック条件、影響範囲の記法。

### Appendix D. 自動テストフック
> 次Revで追加。ピクセルマッチ閾値、スナップショット比較、CI統合例。
